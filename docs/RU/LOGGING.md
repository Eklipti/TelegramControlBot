# Система логирования ControlBot v3.0.0

## Описание уровней логирования

### CRITICAL (50)
**Назначение**: ошибки, которые приводят к аварийному завершению работы программы.

**Примеры использования**:
- Недоступность критически важных сервисов
- Ошибки инициализации, которые делают приложение неработоспособным
- Критические сбои безопасности
- Ошибки, требующие немедленного вмешательства

**Файлы**: `all.log`, `critical.log`

### ERROR (40)
**Назначение**: ошибки, которые могут повлиять на функциональность, но приложение продолжает работать.

**Примеры использования**:
- Ошибки обработки запросов
- Сбои в работе отдельных модулей
- Ошибки подключения к внешним сервисам
- Ошибки валидации данных

**Файлы**: `all.log`, `error.log`

### WARNING (30)
**Назначение**: предупреждения о ситуациях, которые могут привести к ошибке в будущем, но не влияют на текущую работу программы.

**Примеры использования**:
- Превышение лимитов ресурсов
- Устаревшие конфигурации
- Потенциальные проблемы безопасности
- Неоптимальные настройки

**Файлы**: `all.log`, `warn.log`

### INFO (20)
**Назначение**: обычная информация о работе программы, которая помогает понять его функционирование.

**Примеры использования**:
- Запуск и завершение функций
- Успешные операции
- Изменения состояния программы
- Пользовательские действия

**Файлы**: `all.log`, `info.log`

### DEBUG (10)
**Назначение**: подробная информация для отладки, полезная разработчикам при поиске и устранении ошибок.

**Примеры использования**:
- Детали выполнения алгоритмов
- Промежуточные значения переменных
- Состояние объектов
- Временная отладочная информация

**Файлы**: `all.log`, `debug.log`

### TRACE (5)
**Назначение**: подробный уровень, записывающий всю информацию о выполнении, включая детали о вызовах методов и потоках.

**Примеры использования**:
- Вход и выход из функций
- Пошаговое выполнение алгоритмов
- Детали работы с потоками
- Трассировка выполнения кода

**Файлы**: `all.log`, `trace.log`

## Структура файлов логов

```
./logs/
├── all.log          # Все логи в хронологическом порядке
├── critical.log     # Только CRITICAL уровень
├── error.log        # Только ERROR уровень
├── warn.log         # Только WARNING уровень
├── info.log         # Только INFO уровень
├── debug.log        # Только DEBUG уровень
└── trace.log        # Только TRACE уровень
```

## Формат записей

```
YYYY-MM-DD HH:MM:SS | LEVEL     | LOGGER_NAME | MESSAGE
```

## Использование в коде

```python
from app.core.logging import critical, error, warning, info, debug, trace
from app.core.logging import trace_function_entry, trace_function_exit, trace_step

# Базовое логирование
info("Приложение запущено")
error("Ошибка подключения к базе данных")
critical("Критическая ошибка безопасности")

# TRACE логирование
trace_function_entry("process_user_data", args=(user_id,), kwargs={"validate": True})
trace_step("Валидация данных пользователя")
trace_function_exit("process_user_data", result="success")
```

## Особенности

1. **Кодировка**: Все файлы логов используют UTF-8
2. **Автоматическая очистка**: Файл `all.log` очищается при каждом запуске бота
3. **Централизованное хранилище**: Логи сохраняются не только в файлы, но и в память для быстрого доступа
4. **Экспорт в различные форматы**: JSON, CSV, XML, TXT
5. **Асинхронность**: Операции экспорта не блокируют event loop

## Централизованная система логирования

С версии 2.2.1 в ControlBot реализована централизованная система логирования, которая собирает все логи в единое хранилище в памяти для быстрого доступа и анализа.

### Возможности

- **Хранение в памяти**: До 10,000 последних записей логов в оперативной памяти
- **Статистика в реальном времени**: Подсчет логов по уровням и логгерам
- **Фильтрация**: По уровню, логгеру, временному диапазону
- **Экспорт**: В JSON, CSV, XML, TXT форматы
- **Асинхронный экспорт**: Использование `asyncio.to_thread()` для неблокирующих операций

### Команды управления логами

#### `/logs_export`
Интерактивное меню экспорта логов с выбором формата и просмотром статистики.

#### `/logs_export_json`
Быстрый экспорт всех логов в JSON формат с метаданными и статистикой.

#### `/logs_export_csv`
Экспорт логов в CSV формат для анализа в Excel или других инструментах.

#### `/logs_export_xml`
Экспорт логов в XML формат со структурированными данными.

#### `/logs_export_txt`
Экспорт логов в человекочитаемый текстовый формат.

#### `/logs_filter`
Фильтрация логов по критериям:
```bash
/logs_filter --level ERROR              # Только ошибки
/logs_filter --logger auth              # Только логи авторизации
/logs_filter --hours 24                 # За последние 24 часа
/logs_filter --limit 100                # Максимум 100 записей
/logs_filter --level ERROR --hours 1    # Комбинация фильтров
```

**Параметры:**
- `--level LEVEL` - фильтр по уровню (CRITICAL, ERROR, WARNING, INFO, DEBUG, TRACE)
- `--logger NAME` - фильтр по имени логгера
- `--hours N` - логи за последние N часов
- `--limit N` - максимальное количество записей (по умолчанию 100)

#### `/logs_cleanup [дни]`
Очистка старых файлов экспорта. По умолчанию удаляет файлы старше 30 дней.

```bash
/logs_cleanup      # Удалить файлы старше 30 дней
/logs_cleanup 7    # Удалить файлы старше 7 дней
```

## Дополнительные возможности

### Декоратор @log_call

Автоматическое TRACE-логирование входа и выхода из функций:

```python
from app.core.logging import log_call

@log_call(logger_name="my_module")
async def my_async_function(param1, param2):
    # Автоматически логируется вход с параметрами
    result = await do_something()
    # Автоматически логируется выход
    return result

@log_call(logger_name="my_module")
def my_sync_function(data):
    # Работает и с синхронными функциями
    return process(data)
```

### Middleware логирования

`BotInteractionLoggingMiddleware` автоматически логирует все взаимодействия с ботом:
- Входящие сообщения от пользователей
- Callback-запросы от inline-кнопок
- Успешную обработку событий
- Ошибки при обработке

Middleware настраивается в `app/app.py` и работает прозрачно для всех обработчиков.

## Структура директорий

```
./
├── logs/           # Файлы логов
│   ├── all.log
│   ├── critical.log
│   ├── error.log
│   ├── warn.log
│   ├── info.log
│   ├── debug.log
│   └── trace.log
└── exports/        # Экспортированные логи
    ├── logs_export_20250106_143022.json
    ├── logs_export_20250106_143045.csv
    └── ...
```

## Настройка

Уровень логирования настраивается через переменную окружения в `.env`:

```env
LOG_LEVEL=INFO    # DEBUG, INFO, WARNING, ERROR, CRITICAL, TRACE
```

Или через настройки в `app/config/__init__.py`:

```python
from app.config import get_settings

settings = get_settings()
print(settings.log_level)  # Текущий уровень логирования
```

## Производительность

- **Файловое логирование**: Асинхронная запись в файлы не блокирует основной поток
- **Централизованное хранилище**: Ограничено 10,000 записями для контроля памяти
- **Экспорт**: Использует `asyncio.to_thread()` для вынесения блокирующих операций I/O
- **Middleware**: Минимальные накладные расходы благодаря эффективной фильтрации
