# История изменений ControlBot

Все значимые изменения в проекте ControlBot будут документированы в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и проект следует [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [2.2.1] - 2025-09-25

### Исправлено
- **Пути к файлам**: Исправлено резолвирование путей относительно корня проекта вместо `cwd`
- **Кодировка Windows**: Установлена кодировка `cp866` по умолчанию для Windows
- **Инициализация логгера**: Директории создаются ДО инициализации логгера
- **Циклические импорты**: Создано единое место регистрации handlers в `app/handlers/registration.py`
- **Headless режим**: Реализованы ленивые импорты GUI модулей с внятными ошибками

### Добавлено
- **Централизованная система логирования** с экспортом в JSON, CSV, XML, TXT
- **Система метрик и мониторинга** с детальной статистикой
- **Новые команды экспорта логов**: `/logs_export`, `/logs_export_json`, `/logs_export_csv`, `/logs_export_xml`, `/logs_export_txt`
- **Команды статистики**: `/stats`, `/stats_commands`, `/stats_users`, `/stats_performance`, `/stats_patterns`, `/stats_audit`, `/stats_export`
- **Команды фильтрации логов**: `/logs_filter`, `/logs_cleanup`
- **Новые методы для путей**: `get_project_root()`, `get_default_paths_file()`, `get_paths_config_file()`, `get_logs_directory()`
- **Ленивые импорты GUI**: `lazy_import_cv2()`, `lazy_import_pyautogui()`, `lazy_import_pil()`
- **Улучшенные сообщения об ошибках** для headless режима
- **Централизованная регистрация handlers** в `app/handlers/registration.py`
- **Улучшенная система логирования** с поддержкой всех уровней
- **Декораторы для автоматического сбора метрик** (`@track_command_metrics`)
- **Система подтверждений для опасных действий** с таймаутами

### Изменено
- **Handlers обновлены** для использования ленивых импортов
- **Архитектура handlers** - централизованная регистрация
- **Обработка ошибок** - подробные сообщения с инструкциями
- **Объединение GUI mode** - объединение GUI_MODE (=true) и HEADLESS_MODE (=false) в один

## [2.2.0] - 2025-09-20

### Добавлено
- **Новая архитектура модулей** с разделением на `core`, `config` и `handlers`
- **Единый источник правды для путей** - `app/config/paths.py` с Pydantic Settings
- **Улучшенная система безопасности** с централизованной логикой в `app/core/security.py`
- **Структурированная организация скриптов** в папке `scripts/windows/`
- **Обновленная документация** с описанием новой структуры проекта

### Изменено
- **Рефакторинг модулей безопасности**:
  - `app/security.py` → использует общую логику из `app/core/security.py`
  - `app/handlers/security.py` → `app/handlers/security_handlers.py`
- **Рефакторинг системы путей**:
  - `app/paths_config.py` → обратная совместимость с новым API
  - `app/handlers/paths.py` → `app/handlers/paths_handlers.py`
  - Новая реализация в `app/config/paths.py` с Pydantic Settings
- **Переименование файлов для лучшей читаемости**:
  - `app/handlers/docs_photos.py` → `app/handlers/attachments.py`
  - `app/handlers/find_cmd.py` → `app/handlers/command_search.py`
  - `app/handlers/rdp.py` → `app/handlers/remote_desktop.py`
- **Перемещение скриптов**:
  - `ControlBot.bat` → `scripts/windows/ControlBot.bat`
- **Обновление импортов** во всех затронутых файлах

### Исправлено
- **Обратная совместимость** сохранена для всех публичных API
- **Пути в скриптах** исправлены для работы из новой структуры папок
- **Валидация путей** в Pydantic Settings исправлена

## [2.1.0] - 2025-09-20

### Добавлено
- **Pydantic Settings** для управления конфигурацией приложения
- **Валидация настроек** с автоматической проверкой параметров
- **Расширенная система конфигурации** с поддержкой всех режимов работы
- **Улучшенная документация** по настройке и использованию
- **Тесты конфигурации** с полным покрытием функциональности
- **Миграционные инструкции** для перехода со старой системы

### Изменено
- **Система конфигурации** переведена на Pydantic v2
- **.env.example** полностью синхронизирован с новыми настройками
- **Документация разработчика** обновлена с примерами использования
- **Структура проекта** дополнена модулем `app/config/`

## [2.0.1] - 2025-09-20

### Добавлено
- Универсальный раннер тестов `run_tests.py` с делегированием в pytest
- CI/CD конфигурация с матрицей по операционным системам
- Поддержка передачи дополнительных аргументов pytest через раннер

### Изменено
- Упрощена система тестирования - удалены множественные скрипты
- Обновлена документация по тестированию
- Изменен формат вывода тестов на quiet mode (-q) по умолчанию

### Удалено
- `run_all_tests.py` - заменен на `run_tests.py --all`
- `run_headless_tests.py` - заменен на `run_tests.py --headless`

### Исправлено
- Циклические импорты в `app/handlers/__init__.py`
- Обновлена CI конфигурация для использования нового раннера

## [2.0.0] - 2025-01-18

### Добавлено
- Полная переработка архитектуры с использованием Aiogram 3
- Система управления путями с предустановленными и пользовательскими путями
- Интерактивная командная строка с автообновлениями
- RDP-трансляция экрана с настраиваемым FPS
- Поддержка headless-режима для CI/CD
- Автоматическая регистрация команд в Telegram меню
- Универсальный раннер тестов `run_tests.py`
- CI/CD с матрицей по операционным системам (Windows, Ubuntu, macOS)
- Поддержка pytest -q (quiet mode) как основного режима

### Изменено
- Улучшен пользовательский интерфейс с inline-клавиатурами
- Упрощена система тестирования - один раннер вместо множества скриптов
- Обновлена CI конфигурация для поддержки кроссплатформенного тестирования
- Изменен формат вывода тестов на quiet mode по умолчанию

### Удалено
- Устаревшие команды и функции
- Зависимости от старых версий библиотек
- Множественные скрипты запуска тестов (`run_all_tests.py`, `run_headless_tests.py`)

### Исправлено
- Проблемы с совместимостью Python 3.11+
- Ошибки в работе с GUI модулями в headless-окружении
- Проблемы с кодировкой в Windows
- Утечки памяти при длительной работе
- Циклические импорты в handlers

### Безопасность
- Добавлены ограничения доступа к системным директориям
- Улучшена валидация пользовательского ввода
- Добавлены таймауты для предотвращения зависания
- Реализована система логирования операций

## [1.x.x] - 2024

### Примечание
Версии 1.x.x больше не поддерживаются. Рекомендуется обновление до версии 2.0.0.

---

## Типы изменений

- **Добавлено** - для новых функций
- **Изменено** - для изменений в существующей функциональности
- **Устарело** - для функций, которые будут удалены в будущих версиях
- **Удалено** - для удаленных функций
- **Исправлено** - для исправления багов
- **Безопасность** - для исправлений уязвимостей

## Формат версий

Проект использует [Semantic Versioning](https://semver.org/):
- **MAJOR** - несовместимые изменения API
- **MINOR** - новая функциональность с обратной совместимостью
- **PATCH** - исправления багов с обратной совместимостью

## Планы на будущее

См. [FUTURE.md](FUTURE.md) для информации о планируемых функциях и улучшениях.

---

*Последнее обновление: 2025-09-20*
